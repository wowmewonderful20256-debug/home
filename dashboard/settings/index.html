<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeSphere | Settings</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* --- Layout & theme match to your other pages (kept identical) --- */
    :root { --card-bg: rgba(255,255,255,0.08); --card-bg-2: rgba(255,255,255,0.12); --accent: #ff8a00; --accent-2:#e52e71; }
    body { margin:0; font-family:'Poppins',sans-serif; background: linear-gradient(135deg,#5d54a4,#7c78b8); color:#fff; overflow-x:hidden;}
    header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background: rgba(255,255,255,0.1); backdrop-filter: blur(8px); position:fixed; width:100%; top:0; z-index:10; }
    .menu-btn { font-size:2rem; cursor:pointer; transition: transform .3s; } .menu-btn:hover { transform:scale(1.06); }
    .title { font-weight:600; font-size:1.4rem; }
    .right { display:flex; align-items:center; gap:1rem; }
    .clock, .logout-btn { font-weight:600; }
    .logout-btn { cursor:pointer; background: rgba(255,255,255,0.15); padding:0.5rem 1rem; border-radius:8px; transition: background .2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.28); }

    /* side menu */
    #sideMenu { position:fixed; top:0; left:-260px; width:260px; height:100%; background: rgba(0,0,0,0.32); backdrop-filter: blur(8px); padding-top:4rem; transition:left .35s; z-index:20; }
    #sideMenu.open { left:0; }
    #sideMenu a { display:flex; align-items:center; gap:1rem; padding:1rem 1.25rem; color:white; text-decoration:none; transition: background .18s; }
    #sideMenu a:hover { background: rgba(255,255,255,0.06); }
    #menuOverlay { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.32); z-index:15; }
    #menuOverlay.show { display:block; }

    main { margin-top:90px; padding:2rem; display:flex; flex-direction:column; gap:1.5rem; align-items:center; }
    .container { width:90%; max-width:1000px; }
    .card { width:100%; background:var(--card-bg); border-radius:18px; padding:20px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }

    .heading { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .heading h2 { margin:0; font-size:1.25rem; }

    /* tabs */
    .tabs { display:flex; gap:8px; margin-bottom:14px; }
    .tab {
      display:flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:12px; cursor:pointer;
      background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.04);
      transition: background .18s, color .18s;
    }
    .tab .icon { font-size:18px; opacity:0.95; display:inline-flex; align-items:center; justify-content:center; }
    .tab .txt { font-weight:600; }
    .tab.active {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #000;
      box-shadow: 0 8px 22px rgba(0,0,0,0.3);
    }

    /* content area */
    .settings-grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    label { display:block; margin-bottom:6px; font-weight:600; color: #fff; }
    .muted { color: rgba(255,255,255,0.9); font-size:0.95rem; }
    select, input[type="text"] {
      width:100%; padding:10px; border-radius:10px; border:none; outline:none;
      background: rgba(255,255,255,0.06); color:white; font-size:1rem;
    }
    .section-block { background: rgba(255,255,255,0.02); padding:12px; border-radius:12px; }

    .coming-soon { color: #ffd24d; font-weight:700; margin-top:6px; }

    .actions { display:flex; justify-content:flex-end; margin-top:14px; }
    .btn { padding:10px 14px; border-radius:10px; cursor:pointer; border:none; font-weight:700; }
    .btn-save { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#000; }

    @media (max-width:700px) {
      .tabs { flex-wrap:wrap; }
    }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn material-icons" id="menuToggle">menu</span>
    <h1 class="title">TimeSphere</h1>
    <div class="right">
      <div class="clock" id="clock">--:--</div>
      <div class="logout-btn" id="logoutBtn">Logout</div>
    </div>
  </header>

  <nav id="sideMenu">
    <a href="/home/dashboard/"><span class="material-icons">home</span>Dashboard</a>
    <a href="/home/dashboard/users/"><span class="material-icons">group</span>Users</a>
    <a href="/home/dashboard/groups/"><span class="material-icons">groups</span>Groups</a>
    <a href="/home/dashboard/create/"><span class="material-icons">add_circle</span>Create</a>
    <a href="/home/dashboard/user-storage/"><span class="material-icons">storage</span>Storage</a>
    <a href="/home/dashboard/coins/"><span class="material-icons">paid</span>Coins</a>
    <a href="/home/dashboard/quests-and-rewards/"><span class="material-icons">emoji_events</span>Quests</a>
    <a href="/home/dashboard/settings/"><span class="material-icons">settings</span>Settings</a>
  </nav>
  <div id="menuOverlay"></div>

  <main>
    <div class="container">
      <div class="card">
        <div class="heading">
          <h2>Settings</h2>
          <div class="muted">Account preferences & site settings</div>
        </div>

        <!-- TAB BAR -->
        <div class="tabs" role="tablist" aria-label="Settings tabs">
          <div class="tab active" data-tab="account" role="tab" aria-selected="true" title="Account Settings">
            <span class="icon material-icons">settings</span>
            <span class="txt">Account Settings</span>
          </div>
          <a class="tab" href="/home/dashboard/settings/more/" title="Updates & Rules">
            <span class="icon material-icons">article</span>
            <span class="txt">Updates / Rules</span>
          </a>
          <a class="tab" href="/home/dashboard/settings/help/" title="Help">
            <span class="icon material-icons">help_outline</span>
            <span class="txt">Help</span>
          </a>
          <a class="tab" href="/home/dashboard/settings/faq/" title="FAQ">
            <span class="icon material-icons">info</span>
            <span class="txt">FAQ</span>
          </a>
        </div>

        <!-- TAB CONTENT -->
        <div id="tabContent">
          <!-- Account tab (default) -->
          <div id="account" class="settings-grid">
            <!-- Change username -->
            <div class="section-block">
              <label>Change username / uid</label>
              <div class="muted">This feature is coming soon</div>
            </div>

            <!-- Change password -->
            <div class="section-block">
              <label>Change password</label>
              <div class="muted">Click the button to receive a password reset email at your account email.</div>
              <div style="margin-top:10px;">
                <button id="changePasswordBtn" class="btn">Send password reset email</button>
                <div id="pwNotice" class="muted" style="margin-top:8px;"></div>
              </div>
            </div>

            <!-- Select theme -->
            <div class="section-block">
              <label>Select theme</label>
              <select id="themeSelect">
                <option value="timesphere">TimeSphere theme (standard)</option>
                <option value="timesphere-dark">TimeSphere Dark (Night Mode)</option>
              </select>
              <div class="muted" style="margin-top:8px;">Timesphere Dark will apply a dark look; works on settings page as well.</div>
            </div>

            <!-- Change language -->
            <div class="section-block">
              <label>Change language</label>
              <select id="languageSelect">
                <option value="en">English (Standard)</option>
                <option value="pl" disabled>Poland (Soon)</option>
              </select>
            </div>

            <!-- Timezone in banner -->
            <div class="section-block">
              <label>Select Timezone in banner</label>
              <div class="muted">This feature is coming soon</div>
            </div>

            <div class="actions">
              <button id="saveBtn" class="btn btn-save">Save changes</button>
            </div>
          </div>

          <!-- Placeholders for other tabs (links above navigate out). If user clicks the anchor, page will navigate. -->
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // Firebase + page logic
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    // use same firebaseConfig as other pages
    const firebaseConfig = {
      apiKey: "AIzaSyBiGzil9wA3CXZWxWjHsn7iKPkiYQozQW8",
      authDomain: "timesphere-9f7e0.firebaseapp.com",
      projectId: "timesphere-9f7e0",
      storageBucket: "timesphere-9f7e0.appspot.com",
      messagingSenderId: "94629610195",
      appId: "1:94629610195:web:a037e5c5aa0c5ba7e50a26"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // page elements
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const logoutBtn = document.getElementById('logoutBtn');
    const clockEl = document.getElementById('clock');

    // simple header clock (Europe/London)
    function updateHeaderClock(){
      const now = new Date();
      try {
        const options = { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Europe/London' };
        clockEl.textContent = new Intl.DateTimeFormat('en-GB', options).format(now);
      } catch(e){
        clockEl.textContent = now.toLocaleTimeString('en-GB', {hour12:false});
      }
    }
    setInterval(updateHeaderClock,1000);
    updateHeaderClock();

    if(menuToggle && sideMenu && menuOverlay){
      menuToggle.addEventListener('click', ()=>{ sideMenu.classList.add('open'); menuOverlay.classList.add('show'); });
      menuOverlay.addEventListener('click', ()=>{ sideMenu.classList.remove('open'); menuOverlay.classList.remove('show'); });
    }

    if(logoutBtn){
      logoutBtn.addEventListener('click', ()=>{ location.href = '/login/index.html'; });
    }

    // tabs: only local tab is "account". Other three are anchors linking to other pages.
    document.querySelectorAll('.tabs .tab').forEach(t => {
      t.addEventListener('click', (ev) => {
        // if it is an anchor (<a>), let default navigation happen
        if(t.tagName.toLowerCase() === 'a') return;
        const tab = t.dataset.tab;
        if(!tab) return;
        // clear active
        document.querySelectorAll('.tabs .tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        // show only the matching content block (we only have #account here)
        document.querySelectorAll('#tabContent > div').forEach(c => c.style.display = (c.id === tab ? '' : 'none'));
      });
    });

    // init: hide non-account content blocks if any (only account present, so fine)
    document.querySelectorAll('#tabContent > div').forEach(c => {
      if(c.id !== 'account') c.style.display = 'none';
    });

    // UI elements
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const pwNotice = document.getElementById('pwNotice');
    const themeSelect = document.getElementById('themeSelect');
    const languageSelect = document.getElementById('languageSelect');
    const saveBtn = document.getElementById('saveBtn');

    let currentUser = null;
    let initialSettings = {};

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        // redirect if not logged
        try { location.href = '/login/index.html'; } catch(e){}
        return;
      }
      currentUser = user;

      // load existing settings from Firestore (user_settings/{uid})
      try{
        const sRef = doc(db, 'user_settings', user.uid);
        const sSnap = await getDoc(sRef);
        if(sSnap.exists()){
          const data = sSnap.data();
          initialSettings = { theme: data.theme || 'timesphere', language: data.language || 'en' };
        } else {
          initialSettings = { theme: 'timesphere', language: 'en' };
        }
      } catch(err){
        console.error('Load settings error', err);
        initialSettings = { theme: 'timesphere', language: 'en' };
      }

      // apply to UI
      themeSelect.value = initialSettings.theme || 'timesphere';
      languageSelect.value = initialSettings.language || 'en';
      applyThemePreview(themeSelect.value);
    });

    // change password handler
    changePasswordBtn?.addEventListener('click', async () => {
      if(!currentUser || !currentUser.email){
        alert('Could not detect your account email. Make sure you are logged in.');
        return;
      }
      try{
        pwNotice.textContent = 'Sending password reset email...';
        await sendPasswordResetEmail(auth, currentUser.email);
        pwNotice.textContent = 'Password reset email sent â€” check your inbox.';
      } catch(err){
        console.error('sendPasswordResetEmail error', err);
        pwNotice.textContent = 'Error sending email: ' + (err.message || err);
      }
    });

    // preview theme selection (applies small visual tweak here)
    function applyThemePreview(val){
      // for settings page we just add/remove class on body to roughly represent theme
      if(val === 'timesphere-dark'){
        document.body.style.filter = 'brightness(.92)';
      } else {
        document.body.style.filter = '';
      }
    }
    themeSelect?.addEventListener('change', (e) => applyThemePreview(e.target.value));

    // Save changes
    saveBtn?.addEventListener('click', async () => {
      if(!currentUser) return alert('Not signed in');
      const toSave = {
        theme: themeSelect.value || 'timesphere',
        language: languageSelect.value || 'en',
        updatedAt: serverTimestamp()
      };
      try{
        await setDoc(doc(db, 'user_settings', currentUser.uid), toSave, { merge: true });
        // update initialSettings so repeated Save won't show as change
        initialSettings = { theme: toSave.theme, language: toSave.language };
        alert('Settings saved.');
      } catch(err){
        console.error('Save settings error', err);
        alert('Failed to save settings: ' + (err.message || err));
      }
    });

    // optional: disable Poland until ready (already disabled in DOM)
  </script>
</body>
</html>
