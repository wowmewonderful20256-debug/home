<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TimeSphere | Edit Current Time</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body {
    margin:0; font-family:'Poppins',sans-serif;
    background: linear-gradient(135deg,#5d54a4,#7c78b8);
    color:#fff; overflow-x:hidden;
  }
  header {
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 1.5rem;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
    position:fixed; width:100%; top:0; z-index:10;
  }
  .menu-btn { font-size:2rem; cursor:pointer; }
  .title { font-weight:600; font-size:1.25rem; }
  .right { display:flex; align-items:center; gap:0.8rem; }
  .clock { font-weight:600; min-width:100px; text-align:right; }
  .logout-btn { cursor:pointer; background: rgba(255,255,255,0.12); padding:0.4rem 0.8rem; border-radius:8px; font-weight:600; }
  .logout-btn:hover { background: rgba(255,255,255,0.22); }

  #sideMenu {
    position:fixed; top:0; left:-260px;
    width:260px; height:100%;
    background: rgba(0,0,0,0.32); backdrop-filter: blur(8px);
    padding-top:4rem; transition:left .35s; z-index:20;
  }
  #sideMenu.open { left:0; }
  #sideMenu a { display:flex; align-items:center; gap:1rem; padding:1rem 1.25rem; color:white; text-decoration:none; transition: background .18s; }
  #sideMenu a:hover { background: rgba(255,255,255,0.06); }

  #menuOverlay { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.32); z-index:15; }
  #menuOverlay.show { display:block; }

  main { margin-top:92px; padding:2rem; display:flex; justify-content:center; }
  .card {
    width:100%; max-width:920px;
    background: rgba(255,255,255,0.06);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    text-align:center;
  }

  input, select, button {
    width: 80%; max-width:400px; padding:0.5rem 0.8rem; margin:0.5rem 0; border-radius:10px;
    border:none; outline:none; font-size:1rem;
  }
  input, select { background: rgba(255,255,255,0.2); color:#fff; }
  button {
    background: rgba(255,255,255,0.2); color:#fff; cursor:pointer; font-weight:600;
    transition: background 0.3s; border-radius:10px;
  }
  button:hover { background: rgba(255,255,255,0.4); }

  .time-preview { font-size:2rem; font-weight:700; margin-top:12px; }
  .muted { color: rgba(255,255,255,0.8); font-size:0.95rem; margin-top:6px; }
</style>
</head>
<body>
<header>
  <span class="menu-btn material-icons" id="menuToggle">menu</span>
  <div class="title">TimeSphere</div>
  <div class="right">
    <div class="clock" id="clock">--:--:--</div>
    <div class="logout-btn" id="logoutBtn">Logout</div>
  </div>
</header>

<nav id="sideMenu" aria-hidden="true">
  <a href="/home/dashboard/"><span class="material-icons">home</span>Dashboard</a>
  <a href="/home/dashboard/users/"><span class="material-icons">group</span>Users</a>
  <a href="/home/dashboard/groups/"><span class="material-icons">groups</span>Groups</a>
  <a href="/home/dashboard/create/"><span class="material-icons">add_circle</span>Create</a>
  <a href="/home/dashboard/user-storage/"><span class="material-icons">storage</span>Storage</a>
  <a href="/home/dashboard/coins/"><span class="material-icons">paid</span>Coins</a>
  <a href="/home/dashboard/quests-and-rewards/"><span class="material-icons">emoji_events</span>Quests</a>
  <a href="/home/dashboard/settings/"><span class="material-icons">settings</span>Settings</a>
</nav>
<div id="menuOverlay" tabindex="-1"></div>

<main>
  <div class="card">
    <div style="font-size:1.5rem;font-weight:700;" id="timeName">Loading Current Time...</div>
    <div class="muted" id="tzText">—</div>

    <input type="text" id="timeNameInput" placeholder="Enter time name" />
    <select id="tzSelect"></select>
    <select id="themeSelect">
      <option value="light">Light Theme</option>
      <option value="dark">Dark Theme</option>
    </select>

    <div class="time-preview" id="timePreviewDisplay">--:--:--</div>

    <button id="saveBtn">Save Current Time and redirect to your time page</button>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBiGzil9wA3CXZWxWjHsn7iKPkiYQozQW8",
  authDomain: "timesphere-9f7e0.firebaseapp.com",
  projectId: "timesphere-9f7e0",
  storageBucket: "timesphere-9f7e0.firebasestorage.app",
  messagingSenderId: "94629610195",
  appId: "1:94629610195:web:a037e5c5aa0c5ba7e50a26"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Header clock Europe/London
function updateHeaderClock() {
  const now = new Date();
  const options = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Europe/London' };
  document.getElementById('clock').textContent = new Intl.DateTimeFormat('en-GB', options).format(now);
}
setInterval(updateHeaderClock, 1000);
updateHeaderClock();

// Menu toggle
const sideMenu = document.getElementById('sideMenu');
const overlay = document.getElementById('menuOverlay');
document.getElementById('menuToggle').addEventListener('click', () => {
  sideMenu.classList.add('open'); overlay.classList.add('show');
});
overlay.addEventListener('click', () => {
  sideMenu.classList.remove('open'); overlay.classList.remove('show');
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  location.href = '/login/index.html';
});

// Inputs
const timeNameInput = document.getElementById('timeNameInput');
const tzSelect = document.getElementById('tzSelect');
const themeSelect = document.getElementById('themeSelect');
const timePreviewDisplay = document.getElementById('timePreviewDisplay');
const saveBtn = document.getElementById('saveBtn');

// Populate timezone dropdown UTC-12 → UTC+14
for(let i=-12;i<=14;i++){
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = `UTC${i>=0?'+':'-'}${Math.abs(i)}`;
  tzSelect.appendChild(opt);
}

// Get current time id from URL
const params = new URLSearchParams(window.location.search);
const timeId = params.get('id');

// Load Current Time
onAuthStateChanged(auth, async (user) => {
  if(!user) { location.href='/login/index.html'; return; }

  if(!timeId) return alert('Time not found!');
  const docRef = doc(db, 'current_times', timeId);
  const docSnap = await getDoc(docRef);
  if(!docSnap.exists()) return alert('Time not found!');

  const data = docSnap.data();

  // Only owner can edit
  if(user.uid !== data.ownerUid) {
    alert('You are not the owner of this Time.');
    location.href = '/home/dashboard/time.html?id=' + encodeURIComponent(timeId);
    return;
  }

  // Populate fields
  timeNameInput.value = data.name || '';
  tzSelect.value = data.timeZone || 0;
  themeSelect.value = data.theme || 'light';

  updateTimePreview();
});

// Digital preview clock
function updateTimePreview() {
  const tzOffset = parseInt(tzSelect.value) || 0;
  const theme = themeSelect.value;
  const now = new Date(Date.now() + tzOffset*3600*1000);

  const hours = String(now.getUTCHours()).padStart(2,'0');
  const minutes = String(now.getUTCMinutes()).padStart(2,'0');
  const seconds = String(now.getUTCSeconds()).padStart(2,'0');

  timePreviewDisplay.textContent = `${hours}:${minutes}:${seconds}`;

  timePreviewDisplay.style.color = theme==='light'?'#000':'#fff';
}

// Update preview every second
setInterval(updateTimePreview, 1000);

// Update preview on select changes
tzSelect.addEventListener('change', updateTimePreview);
themeSelect.addEventListener('change', updateTimePreview);

// Save changes
saveBtn.addEventListener('click', async ()=>{
  const name = timeNameInput.value.trim();
  const tz = parseInt(tzSelect.value);
  const theme = themeSelect.value;

  if(!name) { alert('Enter Time name'); return; }

  const docRef = doc(db, 'current_times', timeId);
  await updateDoc(docRef, { name, timeZone: tz, theme });

  window.location.href = `/home/dashboard/time.html?id=${encodeURIComponent(timeId)}`;
});
</script>
</body>
</html>
