<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TimeSphere | Create Clock</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body { font-family:'Poppins',sans-serif; margin:0; background: linear-gradient(135deg,#5d54a4,#7c78b8); color:white; overflow-x:hidden; }
  header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background: rgba(255,255,255,0.1); backdrop-filter: blur(8px); position:fixed; width:100%; top:0; z-index:10; }
  .menu-btn { font-size:2rem; cursor:pointer; transition: transform .3s; } .menu-btn:hover { transform:scale(1.06); }
  .title { font-weight:600; font-size:1.4rem; }
  .right { display:flex; align-items:center; gap:1rem; }
  .clock, .logout-btn { font-weight:600; }
  .logout-btn { cursor:pointer; background: rgba(255,255,255,0.15); padding:0.5rem 1rem; border-radius:8px; transition: background .2s; }
  .logout-btn:hover { background: rgba(255,255,255,0.28); }

  main { margin-top:90px; padding:2rem; display:flex; flex-direction:column; gap:1.5rem; align-items:center; }
  .section { width:90%; max-width:700px; background: rgba(255,255,255,0.1); border-radius:18px; padding:20px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); text-align:center; }

  label { display:block; margin-top:10px; margin-bottom:5px; font-weight:600; }
  input, select { width:100%; padding:0.5rem; border-radius:10px; border:none; outline:none; margin-bottom:1rem; background: rgba(255,255,255,0.2); color:white; }

  #clockPreview { margin:20px auto; display:block; border-radius:50%; background: rgba(255,255,255,0.05); position:relative; }

  button { padding:0.5rem 1rem; border:none; border-radius:10px; cursor:pointer; background: rgba(255,255,255,0.2); color:white; transition:0.3s; }
  button:hover { background: rgba(255,255,255,0.4); }

</style>
</head>
<body>
<header>
  <span class="menu-btn material-icons" id="menuToggle">menu</span>
  <h1 class="title">TimeSphere</h1>
  <div class="right">
    <div class="clock" id="clock">--:--</div>
    <div class="logout-btn" id="logoutBtn">Logout</div>
  </div>
</header>

<main>
  <div class="section">
    <h2>Create Clock</h2>
    <label>Clock Name:</label>
    <input type="text" id="clockNameInput" placeholder="Clock Name" />

    <label>Time Zone:</label>
    <select id="timeZoneSelect">
      <!-- UTC+14 do UTC-12 -->
      <option value="+14">UTC+14</option>
      <option value="+13">UTC+13</option>
      <option value="+12">UTC+12</option>
      <option value="+11">UTC+11</option>
      <option value="+10">UTC+10</option>
      <option value="+9">UTC+9</option>
      <option value="+8">UTC+8</option>
      <option value="+7">UTC+7</option>
      <option value="+6">UTC+6</option>
      <option value="+5">UTC+5</option>
      <option value="+4">UTC+4</option>
      <option value="+3">UTC+3</option>
      <option value="+2">UTC+2</option>
      <option value="+1">UTC+1</option>
      <option value="0">UTC+0</option>
      <option value="-1">UTC-1</option>
      <option value="-2">UTC-2</option>
      <option value="-3">UTC-3</option>
      <option value="-4">UTC-4</option>
      <option value="-5">UTC-5</option>
      <option value="-6">UTC-6</option>
      <option value="-7">UTC-7</option>
      <option value="-8">UTC-8</option>
      <option value="-9">UTC-9</option>
      <option value="-10">UTC-10</option>
      <option value="-11">UTC-11</option>
      <option value="-12">UTC-12</option>
    </select>

    <label>Clock Theme:</label>
    <select id="themeSelect">
      <option value="light">Light</option>
      <option value="dark" selected>Dark</option>
    </select>

    <canvas id="clockPreview" width="250" height="250"></canvas>

    <button id="createBtn">Create Clock and redirect to your clock</button>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBiGzil9wA3CXZWxWjHsn7iKPkiYQozQW8",
  authDomain: "timesphere-9f7e0.firebaseapp.com",
  projectId: "timesphere-9f7e0",
  storageBucket: "timesphere-9f7e0.firebasestorage.app",
  messagingSenderId: "94629610195",
  appId: "1:94629610195:web:a037e5c5aa0c5ba7e50a26"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
  
  // --- STORAGE UPDATE FUNCTION ---
import { doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

async function updateStorageUsage(uid, addedMB) {
  const storageRef = doc(db, "storage", uid);
  const storageSnap = await getDoc(storageRef);
  
  if (!storageSnap.exists()) {
    // jeśli użytkownik nie ma jeszcze storage, utwórz nowy
    await setDoc(storageRef, { used: addedMB });
  } else {
    const current = storageSnap.data().used || 0;
    const newUsage = current + addedMB;
    if (newUsage > 250) {
      alert("Storage limit exceeded (250MB). Cannot create new items.");
      throw new Error("Storage limit exceeded");
    }
    await updateDoc(storageRef, { used: increment(addedMB) });
  }
  }

    // funkcja quest
  async function updateQuestProgress(uid, questId, amount = 1) {
    try {
      const ref = doc(db, "user_quests", `${uid}_${questId}`);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        await setDoc(ref, {
          uid,
          questId,
          doneCount: amount,
          claimed: false
        });
        console.log(`Created new progress for "${questId}"`);
      } else {
        const data = snap.data();
        const newDone = (data.doneCount || 0) + amount;
        await updateDoc(ref, { doneCount: newDone });
        console.log(`Progress updated for "${questId}": ${newDone}`);
      }
    } catch (err) {
      console.error("updateQuestProgress error:", err);
    }
  }
  
/* ---------- helper to safely get element ---------- */
const $ = id => document.getElementById(id);

/* ---------- Header clock (safe) ---------- */
const headerClockEl = $('clock');
if (headerClockEl) {
  function updateHeaderClock() {
    const now = new Date();
    // show Europe/London time as before
    try {
      const options = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Europe/London' };
      headerClockEl.textContent = new Intl.DateTimeFormat('en-GB', options).format(now);
    } catch (e) {
      headerClockEl.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
    }
  }
  updateHeaderClock();
  setInterval(updateHeaderClock, 1000);
} else {
  console.warn('Header clock element #clock not found — skipping header clock init.');
}

/* ---------- Menu toggle (safe) ---------- */
const menuToggle = $('menuToggle');
const sideMenu = $('sideMenu');
const menuOverlay = $('menuOverlay');

if (menuToggle && sideMenu && menuOverlay) {
  menuToggle.addEventListener('click', () => {
    sideMenu.classList.add('open');
    menuOverlay.classList.add('show');
  });
  menuOverlay.addEventListener('click', () => {
    sideMenu.classList.remove('open');
    menuOverlay.classList.remove('show');
  });

  // also close menu on ESC
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { sideMenu.classList.remove('open'); menuOverlay.classList.remove('show'); }});
} else {
  console.warn('Menu elements missing (menuToggle/sideMenu/menuOverlay). Menu will not be interactive.');
}

/* ---------- Logout (safe) ---------- */
const logoutBtn = $('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => { location.href = '/login/index.html'; });
} else {
  console.warn('#logoutBtn not found.');
}

/* ---------- Canvas analog clock (safe init) ---------- */
const canvas = $('clockPreview'); // id from your HTML
let ctx = null;
let logicalRadius = null;
let drawLoopStarted = false;
let tzOffsetHours = 0; // timezone offset for preview (hours)

if (canvas) {
  // ensure canvas has some CSS size; if not, set defaults
  if (!canvas.style.width && !canvas.style.height && canvas.width === 0 && canvas.height === 0) {
    canvas.style.width = '250px';
    canvas.style.height = '250px';
  }

  function initCanvas() {
    // get CSS size and scale for DPR
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx = canvas.getContext('2d');
    if (!ctx) { console.warn('2D context not available'); return; }
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // scale so drawing coordinates = CSS px
    ctx.translate(rect.width / 2, rect.height / 2); // center at (0,0)
    logicalRadius = Math.min(rect.width, rect.height) / 2;
  }

  // call once and also on resize
  initCanvas();
  window.addEventListener('resize', () => {
    try { initCanvas(); } catch (e) { console.warn('Canvas re-init error', e); }
  });

  // drawing functions (use logicalRadius)
  function drawFace(ctx, r, theme) {
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2);
    ctx.fillStyle = theme === 'light' ? '#ffffff' : '#0b0b0b';
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = Math.max(2, r * 0.05);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(0, 0, r * 0.05, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
  }

  function drawNumbers(ctx, r, theme) {
    ctx.font = Math.max(12, r * 0.15) + "px Poppins, sans-serif";
    ctx.textBaseline = "middle";
    ctx.textAlign = "center";
    for (let num = 1; num <= 12; num++) {
      const ang = num * Math.PI / 6;
      ctx.rotate(ang);
      ctx.translate(0, -r * 0.82);
      ctx.rotate(-ang);
      ctx.fillStyle = theme === 'light' ? '#000000' : '#ffffff';
      ctx.fillText(String(num), 0, 0);
      ctx.rotate(ang);
      ctx.translate(0, r * 0.82);
      ctx.rotate(-ang);
    }
  }

  function drawHand(ctx, pos, length, width, color = '#fff') {
    ctx.beginPath();
    ctx.lineWidth = Math.max(1, width);
    ctx.lineCap = "round";
    ctx.strokeStyle = color;
    ctx.moveTo(0, 0);
    ctx.rotate(pos);
    ctx.lineTo(0, -length);
    ctx.stroke();
    ctx.rotate(-pos);
  }

  function drawTime(ctx, r, now) {
    // use hours/minutes/seconds from 'now' (Date object)
    let hour = now.getUTCHours();
    let minute = now.getUTCMinutes();
    let second = now.getUTCSeconds();

    hour = hour % 12;
    const hourAngle = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60)) + (second * Math.PI / (360 * 60));
    drawHand(ctx, hourAngle, r * 0.5, r * 0.07);

    const minuteAngle = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
    drawHand(ctx, minuteAngle, r * 0.75, r * 0.06);

    const secondAngle = (second * Math.PI / 30);
    drawHand(ctx, secondAngle, r * 0.9, r * 0.02, '#ff4b4b');
  }

  function renderOnce(theme) {
    if (!ctx || !logicalRadius) return;
    ctx.clearRect(-logicalRadius - 5, -logicalRadius - 5, logicalRadius * 2 + 10, logicalRadius * 2 + 10);
    const now = new Date(Date.now() + tzOffsetHours * 3600 * 1000);
    drawFace(ctx, logicalRadius, theme);
    drawNumbers(ctx, logicalRadius, theme);
    drawTime(ctx, logicalRadius, now);
  }

  function startDrawLoop(theme) {
    if (drawLoopStarted) return;
    drawLoopStarted = true;
    (function loop() {
      try {
        renderOnce(theme);
      } catch (e) { console.warn('Render error', e); }
      requestAnimationFrame(loop);
    })();
  }

  // expose a small API to update tz/theme externally
  window.__clockPreview = {
    setTimezoneOffsetHours: (h) => { tzOffsetHours = Number(h) || 0; },
    setTheme: (t) => { renderOnce(t); startDrawLoop(t); }
  };

} else {
  console.warn('Canvas #clockPreview not found — skipping preview clock.');
}

/* ---------- Wire up timezone/theme inputs (if present) ---------- */
const tzSelect = $('timeZoneSelect');
const themeSelect = $('themeSelect');
if (tzSelect && window.__clockPreview) {
  tzSelect.addEventListener('input', () => {
    window.__clockPreview.setTimezoneOffsetHours(parseInt(tzSelect.value || '0', 10));
  });
  // initialize with current selection
  window.__clockPreview.setTimezoneOffsetHours(parseInt(tzSelect.value || '0', 10));
} else if (!tzSelect) {
  console.warn('#timeZoneSelect not found.');
}
if (themeSelect && window.__clockPreview) {
  themeSelect.addEventListener('input', () => {
    window.__clockPreview.setTheme(themeSelect.value || 'dark');
  });
  window.__clockPreview.setTheme(themeSelect ? themeSelect.value : 'dark');
} else {
  console.warn('#themeSelect not found.');
}

/* ---------- Create button (safe) ---------- */
const createBtn = $('createBtn');
const clockNameInput = $('clockNameInput');
if (createBtn) {
  createBtn.addEventListener('click', async () => {
    const name = clockNameInput ? clockNameInput.value.trim() : '';
    if (!name) { alert('Enter clock name'); return; }
    const user = auth.currentUser;
    if (!user) { alert('Not signed in'); return; }
    try {
      const docRef = await addDoc(collection(db, 'clocks'), {
        name,
        timeZone: tzSelect ? tzSelect.value : '0',
        theme: themeSelect ? themeSelect.value : 'dark',
        ownerUid: user.uid,
        createdAt: new Date().toISOString()
      });
      await updateQuestProgress(currentUser.uid, "Create clock", 1);
      window.location.href = `/home/dashboard/clock.html?id=${docRef.id}`;
    } catch (e) {
      alert('Creation failed: ' + (e.message || e));
    }
  });
} else {
  console.warn('#createBtn not found.');
}

/* ---------- Auth guard ---------- */
onAuthStateChanged(auth, user => {
  if (!user) {
    // if user not logged in, redirect to login (keeps behavior consistent)
    try { location.href = '/login/index.html'; } catch(e){ console.warn('Redirect failed', e); }
  } else {
    // ensure preview loop started after auth (canvas might already be init)
    if (window.__clockPreview && themeSelect) window.__clockPreview.setTheme(themeSelect.value || 'dark');
  }
});
</script>
</body>
  </html>
