<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimeSphere | Edit Group</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #5d54a4, #7c78b8);
      color: white;
      overflow-x: hidden;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
    }

    .menu-btn { font-size: 2rem; cursor: pointer; transition: transform 0.3s; }
    .menu-btn:hover { transform: scale(1.1); }
    .title { font-weight: 600; font-size: 1.4rem; }
    .right { display: flex; align-items: center; gap: 1rem; }
    .clock, .logout-btn { font-weight: 600; }
    .logout-btn { cursor: pointer; background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; border-radius: 8px; transition: background 0.3s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }

    #sideMenu {
      position: fixed; top: 0; left: -250px; width: 250px; height: 100%;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); padding-top: 4rem; transition: left 0.4s; z-index: 20;
    }
    #sideMenu.open { left: 0; }
    #sideMenu a { display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; color: white; text-decoration: none; transition: background 0.3s; }
    #sideMenu a:hover { background: rgba(255,255,255,0.1); }

    #menuOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index:15; }
    #menuOverlay.show { display:block; }

    main {
      margin-top: 90px;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }

    .section {
      width: 90%; max-width: 700px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .section:nth-child(2) { background: rgba(255,255,255,0.15); }
    .section h2 { font-size: 1.4rem; margin-bottom: 1rem; }

    .user-card, .post-card { display:flex; align-items:center; gap:1rem; padding:0.5rem 0; border-bottom:1px solid rgba(255,255,255,0.2); }
    .user-card .material-icons, .post-card .material-icons { font-size:32px; color:white; }
    .user-card span, .post-card span { font-size:0.9rem; color:white; }

    input, textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 10px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.2);
      color: white;
      margin-bottom: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      border:none;
      border-radius: 10px;
      cursor:pointer;
      background: rgba(255,255,255,0.2);
      color:white;
      transition: 0.3s;
    }
    button:hover { background: rgba(255,255,255,0.4); }
  </style>
</head>
<body>
<header>
  <span class="menu-btn material-icons" id="menuToggle">menu</span>
  <h1 class="title">TimeSphere</h1>
  <div class="right">
    <div class="clock" id="clock">--:--</div>
    <div class="logout-btn" id="logoutBtn">Logout</div>
  </div>
</header>

<nav id="sideMenu">
  <a href="/home/dashboard/"><span class="material-icons">home</span>Dashboard</a>
  <a href="/home/dashboard/users/"><span class="material-icons">group</span>Users</a>
  <a href="/home/dashboard/group/"><span class="material-icons">groups</span>Groups</a>
  <a href="/home/dashboard/create-new-item/"><span class="material-icons">add_circle</span>Create</a>
  <a href="/home/dashboard/user-storage/"><span class="material-icons">storage</span>Storage</a>
  <a href="/home/dashboard/coins/"><span class="material-icons">paid</span>Coins</a>
  <a href="/home/dashboard/quests-and-rewards/"><span class="material-icons">emoji_events</span>Quests</a>
  <a href="/home/dashboard/settings/"><span class="material-icons">settings</span>Settings</a>
</nav>
<div id="menuOverlay"></div>

<main>
  <div class="section" id="groupInfo">
    Loading group...
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBiGzil9wA3CXZWxWjHsn7iKPkiYQozQW8",
    authDomain: "timesphere-9f7e0.firebaseapp.com",
    projectId: "timesphere-9f7e0",
    storageBucket: "timesphere-9f7e0.firebasestorage.app",
    messagingSenderId: "94629610195",
    appId: "1:94629610195:web:a037e5c5aa0c5ba7e50a26"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Clock
  function updateClock() {
    const now = new Date();
    const options = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Europe/London' };
    document.getElementById('clock').textContent = new Intl.DateTimeFormat('en-GB', options).format(now);
  }
  setInterval(updateClock,1000);
  updateClock();

  // Menu toggle
  const sideMenu = document.getElementById('sideMenu');
  const overlay = document.getElementById('menuOverlay');
  document.getElementById('menuToggle').addEventListener('click',()=>{ sideMenu.classList.add('open'); overlay.classList.add('show'); });
  overlay.addEventListener('click',()=>{ sideMenu.classList.remove('open'); overlay.classList.remove('show'); });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async()=>{ await signOut(auth); window.location.href='/login/index.html'; });

  // Get group name from URL
  const params = new URLSearchParams(window.location.search);
  const groupName = params.get("name");

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href='/login/index.html'; return; }

    const groupDiv = document.getElementById("groupInfo");

    if(!groupName){ groupDiv.innerHTML="<p>No group specified.</p>"; return; }

    try{
      const docRef = doc(db,"group",groupName);
      const docSnap = await getDoc(docRef);

      if(!docSnap.exists()){
        groupDiv.innerHTML="<p>Group not found.</p>";
        return;
      }

      const data = docSnap.data();

      // Jeśli current user nie jest ownerem → redirect
      if(user.uid !== data.owner){
        groupDiv.innerHTML=`<p>Redirecting... (Reason: your uid not owner this group)</p>`;
        setTimeout(()=>{ window.location.href="/home/dashboard/groups/"; },3000);
        return;
      }

      // Jeśli jest owner → pokaz pola do edycji
      groupDiv.innerHTML=`
        <h2>Edit Group: ${groupName}</h2>
        <label>Name:</label>
        <input type="text" id="groupNameInput" value="${groupName}" disabled />
        <label>Description:</label>
        <textarea id="groupDescInput">${data.description || ""}</textarea>
        <h3>Posts:</h3>
        <div id="groupPosts">Loading posts...</div>
        <button id="saveBtn">Save Changes</button>
      `;

      // Load posts
      const postsQuery = query(collection(db,"post_group"), where("group","==",groupName));
      const postsSnap = await getDocs(postsQuery);
      const postsDiv = document.getElementById("groupPosts");
      postsDiv.innerHTML="";
      postsSnap.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement("div");
        div.className="post-card";
        div.innerHTML=`<span class="material-icons">post_add</span><span>${d.text}</span>`;
        postsDiv.appendChild(div);
      });

      // Save changes
      document.getElementById("saveBtn").addEventListener("click",async()=>{
        const desc = document.getElementById("groupDescInput").value;
        await db.collection("group").doc(groupName).update({ description: desc });
        alert("Group updated!");
      });

    }catch(err){
      groupDiv.innerHTML=`<p>Error loading group: ${err.message}</p>`;
    }
  });
</script>
</body>
  </html>
